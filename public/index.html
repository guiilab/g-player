<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- <link rel="icon" href="../../favicon.ico"> -->

  <title>Data Visualizer</title>

  <!-- External Style Sheets -->
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />

  <!-- Local Style Sheets -->
  <link href="lib/mprogress.min.css" rel="stylesheet" />
  <link href="css/style.css" rel="stylesheet" />
</head>
<body>
  <i id="loading" class="fa fa-cog fa-spin" style="display: absolute;"></i>

  <!-- Page Content -->
  <div id="wrapper">

    <!-- Left Options Sidebar -->
    <div id="sidebar-wrapper">
      <ul class="sidebar-nav">
        <li class="active"><a href="index.html"><i class="fa fa-map-marker"></i>Home</a></li>
        <li><a href="uploader.html"><i class="fa fa-database"></i>Upload Data</a></li>
        <li onclick="QueryBuilder.open();"><i class="fa fa-search"></i>Build Query</a></li>
        <li onclick="getData();"><i class="fa fa-database"></i>Get Data</li>

        <br>

        <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
          <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="headingOne">
              <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                  <i class="fa fa-sitemap"></i> Select Map
                </a>
              </h4>
            </div>
            <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
              <div class="panel-body">
                <form class="form">

                  <label>Select Game</label>
                  <select class="form-control">
                    <option>Fallout: Mod</option>
                    <option>Quake</option>
                  </select>

                  <br>

                  <label>Select Map</label>
                  <select class="form-control">
                    <option>Outside Area</option>
                    <option>Inside Area</option>
                    <option>Warehouse</option>
                    <option>Desert</option>
                  </select>
                </form>
              </div>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="headingTwo">
              <h4 class="panel-title">
                <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                  <i class="fa fa-table"></i> Select Data
                </a>
              </h4>
            </div>
            <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
              <div class="panel-body">
                <label>Select Players</label>
                <select multiple class="form-control">
                  <option>001</option>
                  <option>002</option>
                  <option>003</option>
                  <option>004</option>
                  <option>005</option>
                </select>
              </div>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="headingThree">
              <h4 class="panel-title">
                <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                  <i class="fa fa-filter"></i> Filter Data
                </a>
              </h4>
            </div>
            <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
              <div class="panel-body">
                <div class="checkbox">
                  <div class="checkbox">
                   <label>
                     <input type="checkbox" id="toggle_heatmap"> Show Player Heatmap
                   </label>
                 </div>
                 <label>
                   <input type="checkbox"> Show Player Deaths
                 </label>
               </div>
               <div class="checkbox">
                 <label>
                   <input type="checkbox"> Show NPC Actions
                 </label>
               </div>
             </div>
           </div>
         </div>
       </div>
     </ul>
   </div>

   <!-- Leaflet.js Map -->
   <div id="map"></div>

 </div><!-- /#wrapper -->

<!-- Query Builder Modal -->
<div class="modal fade" id="query-builder-modal" tabindex="-1" role="dialog" aria-labelledby="queryBuilderLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="queryBuilderLabel">
          <ul class="nav nav-tabs">
            <li role="presentation" class="custom active" onclick="QueryBuilder.mode('custom')"><a href="#">Query Builder</a></li>
            <li role="presentation" class="preset"  onclick="QueryBuilder.mode('preset')"><a href="#">Preset Queries</a></li>
          </ul>  
        </ul>
      </div>
      <div class="modal-body col-sm-12"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary"><i class="fa fa-database"></i> QUERY</button>
      </div>
    </div>
  </div>
</div>

 <!-- External Javascript Dependencies -->
 <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
 <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
 <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.js"></script>

 <!-- Libraries Hosted Locally --> 
 <script src="lib/heatmap.min.js"></script>
 <script src="lib/leaflet-heatmap.js"></script>
 <script src="lib/mprogress.min.js"></script>

 <!-- Custom Javascript -->
 <script src="js/app.js"></script>  <!-- App Functionality -->
 <script src="js/query-builder.js"></script>  <!-- Query Builder Functionality -->

 <!-- Page-Specific Javascript -->
 <script>

  // Toggle Side Options Meny
  $("#toggle-menu").click(function(e) {
    e.preventDefault();
    $("#wrapper").toggleClass("toggled");
  });

  var options = {
    heatmap : true,
  }

  // Save window size.
  var windowWidth  = $(document).width();
  var windowHeight = $(document).height();

  /*************************
         Setup MAP
   *************************/

  // Initialize Map's Size
  $("#map").css("width", windowWidth);
  $("#map").css("height", windowHeight);

  var settings = {

    // Global scale factor.
    // Helps to max points (ranging from -10,000 to 10,000)
    // to their coordinate points on a geo projection.
    scale : 100,

    map : {

      // Save map configuration
      url: "/fallout/intro.png",
      name: "Position_introhouse",
      title: "",
      width : 1600,
      height : 1178,

      // Map player locations to their points
      // on the map. Manually offset for accuracy.
      // Multiplied to base
      offset : {
        x : 650,
        y : 550,
      },

      // Map player locations to their points
      // on the map. Manually scale for accuracy.
      // added to base
      scale : {
        x : 0.45,
        y : 0.45,
      }
    },
  };

  // Given map size, and scale factor,
  // determin the latitude/longitude bounds.
  var latitudeDistance = settings.map.height / settings.scale;
  var longitudeDistance = settings.map.width / settings.scale;

  // Note: Lat/Long is represented as [Latitude (y), Longitude (x)].
  // Take care when converting from cartesian points, to lat/long.        
  var imageBounds = [[0, 0], [latitudeDistance, longitudeDistance]];

  var mapCenter = [latitudeDistance / 2, longitudeDistance / 2];

  // Define Map Parameters
  var map = L.map('map', {
    minZoom: 6,
    maxZoom: 10,
  }).setView(mapCenter, 1);

  // Add image overlay to map
  L.imageOverlay('img/maps/' + settings.map.url, imageBounds).addTo(map);

  /*************************
         Setup DATA
   *************************/

  function getData(){

    $("#loading").show();

      // Hit API
      $.get(API.url + "entries", function(data){

        var offset = settings.map.offset;
        var scale = settings.map.scale;

        // Validate data. Ignore NPC interactions, etc
        // @TODO: Temp data fix. Replaced by proper
        // API and data validation.
        data = _.filter(data, function(p){
          return p.posX && p.posY;
        })

        // Convert data points into plottable data
        data = _.map(data, function(p){
          return { 

              // Create a latitude & longitude field.
              // Maps the (x,y) position to a coordinate
              // on the earth. Makes plotting MUCH easier

              latitude  : ((p.posY + offset.y) * scale.y) / settings.scale,
              longitude : ((p.posX + offset.x) * scale.x) / settings.scale, 

              // Preserve Object

              area : p.area,
              playerID : p.playerID,
              timestamp : p.timestamp,
              cameraX : p.cameraX,
              cameraY : p.cameraY
            }
          })

        plotData(data);
        plotHeatmap(data);

        $("#loading").hide();
      })
  };

  function plotData(data){

   var radius = 10;

   _.each(data, function(p){
     var circle = L.circle([p.latitude, p.longitude], radius, {
       color: 'black',
       fillColor: '#000',
       fillOpacity: 1,
     }).addTo(map);
   });
  }

  /*************************
        Setup HEATMAP
   *************************/

  // http://www.patrick-wied.at/static/heatmapjs/
  var heatmapLayer = new HeatmapOverlay({
    "radius": .5,
    "maxOpacity": .8,
    "scaleRadius": true, 
    "useLocalExtrema": false,
    latField: 'latitude',
    lngField: 'longitude',
  });

  function plotHeatmap(data){

    var heatmapData = { 
      max: 1,  // No idea what this does
      data: data
    };
    
    map.addLayer(heatmapLayer)
    heatmapLayer.setData(heatmapData);     
  }

  /*************************
        Test Coordinates
   *************************/

  addMarker(latitudeDistance,longitudeDistance, "Top Right + " + latitudeDistance + " , " + longitudeDistance);
  addMarker(0,0, "Bottom Left Location [0,0]");

  function addMarker(lat, long, title){
    var title = (title) ? title : "";
    L.marker([lat, long], {title : title}).addTo(map);
  }

  /************************
        Setup UI
  *************************/

  var SideOptionsToggle = L.Control.extend({
    options: {
      position: 'topleft'
    },

    onAdd: function (map) {
      // create the control container with a particular class name
      var button = L.DomUtil.create('div', 'toggle-side-options leaflet-control leaflet-bar');
      var icon = L.DomUtil.create('i', 'fa fa-bars', button);

      // Add Listener
      L.DomEvent.addListener(button, 'click', function(){
        $("#wrapper").toggleClass("toggled");
      });

      return button;
    }
  });

  map.addControl(new SideOptionsToggle());

  $('#loading').hide();

  $('#toggle_heatmap').change(function() {
    // alert(options.heatmap)
    options.heatmap = !options.heatmap;

    if (options.heatmap) map.removeLayer(heatmapLayer)
    if (!options.heatmap) map.addLayer(heatmapLayer)

  });

  $(document).ready(function(){
    QueryBuilder.open();
  })

</script>
</body>
</html>
